# Log Collector

一个高性能的日志收集系统，使用 Spring Boot 构建，专注于实时日志和批量日志的高效处理。

# 日志采集系统需求文档

## 1. 项目概述
实现一个高性能的日志采集和传输系统，能够处理实时日志和批量日志上报，并进行相应处理后存储到本地磁盘。

## 2. 核心功能需求

### 2.1 日志上报接口
#### 2.1.1 实时上报接口
- 提供 HTTP 接口供客户端实时上报单条日志
- 单条日志格式：
  - id（UUID格式）
  - ip
  - event_time（格式如：2020-05-15 18:12:13）
  - name
  - random_number
- 单条日志大小上限：100KB

#### 2.1.2 批量上报接口
- 提供 HTTP 接口接收压缩文件形式的批量日志
- 触发条件（满足任一即可）：
  - 每满 5 条日志
  - 每隔 10 秒
- 使用 ZIP 格式压缩文件
- 失败重试机制：
  - 重试 3 次
  - 重试失败后记录失败日志

### 2.2 服务端处理要求
#### 2.2.1 实时请求处理
- 在原始日志基础上添加字段：
  - process_time（请求处理时间）
  - delay_time（与 event_time 的差值）
- 处理后写入本地磁盘

#### 2.2.2 ZIP文件处理
- 解压缩文件
- 对每条日志添加处理时间和延迟时间字段
- 按行写入本地磁盘

### 2.3 日志存储要求
- 按小时切分日志文件
- 文件命名格式：client_20241014_01.log、client_20241014_02.log 等
- 日志按行写入
- 写入失败处理：
  - 同步写入：返回失败提示
  - 异步写入：放弃本次写入

## 3. 非功能需求

### 3.1 性能要求
- 日请求量：200亿
- 响应时间：P99 < 100ms
- 支持突发高流量
- 业务高峰期：早9点，下午1点
- 写入顺序：允许秒级延迟，不要求严格顺序

### 3.2 技术架构要求
- 编程语言：Java
- 核心设计原则：
  - 高扩展性
  - 高并发
  - 高性能
  - 代码可维护性

## 4. 测试需求
### 4.1 功能测试
- 实时上报接口测试
- 批量上报接口测试
- 日志文件切分测试
- 失败重试机制测试

### 4.2 性能测试
- 高并发测试
- 响应时间测试
- 峰值处理能力测试

## 核心性能特性

### 1. Disruptor 高性能队列
项目使用 LMAX Disruptor 作为核心队列组件，相比传统队列具有显著的性能优势：
- 采用环形缓冲区（RingBuffer）设计，避免垃圾回收
- 无锁设计，减少线程竞争
- 缓存友好的数据结构，提高缓存命中率
- 支持多生产者-多消费者模式

### 2. 异步处理机制
- 使用 CompletableFuture 实现异步日志写入
- 自定义线程池管理写入操作
- 避免 I/O 操作阻塞主线程
- 提高系统整体响应性能

### 3. 批量处理优化
- 实现批量日志缓冲区
- 支持定时批量写入
- 达到阈值时触发批量处理
- 显著减少 I/O 操作次数

### 4. 文件管理优化
- 按小时自动分割日志文件
- 缓存当前文件句柄
- 智能文件命名和管理
- 减少文件系统操作开销

### 5. 并发控制
- 基于 CPU 核心数的线程池优化
- 合理的同步锁策略
- 优化的线程资源利用
- 避免线程竞争和死锁

### 6. 错误处理和重试机制
- 实现智能重试机制
- 优雅的错误处理流程
- 保证数据处理可靠性
- 避免单点故障影响

## 技术栈

- Spring Boot
- LMAX Disruptor
- Java NIO
- CompletableFuture
- Java 并发工具包

## 性能特点

- 高吞吐量：通过 Disruptor 实现高效的内存队列
- 低延迟：异步处理机制确保快速响应
- 可靠性：完善的错误处理和重试机制
- 可扩展：支持水平扩展和集群部署

## 使用场景

- 高并发日志收集
- 实时日志处理
- 批量日志导入
- 分布式系统监控

## 配置说明

主要性能相关配置：

## 最佳实践

1. 根据实际需求调整 RingBuffer 大小
2. 监控并优化线程池配置
3. 根据系统 I/O 能力调整批处理阈值
4. 定期维护日志文件目录
5. 配置合适的重试策略

## 注意事项

- 需要合理配置服务器内存以支持 RingBuffer
- 监控磁盘空间使用情况
- 注意日志文件权限设置
- 考虑定期归档旧日志文件
